{% extends "base.html" %}
{% import '_snippets.html' as snippets %}
{% import '_instructions.html' as instructions %}

{% block title %}
{{dataset.title or dataset.name}} - {{__('Dataset')}}
{% endblock %}

{% block content %}
<!-- data explorer CSS -->
<link rel="stylesheet" type="text/css" href="/static/stylesheets/dataexplorer/main.0e85ebd4.chunk.css">
<link rel="stylesheet" type="text/css" href="/static/stylesheets/dataexplorer/2.0f69c0e7.chunk.css">
<!-- end data explorer CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>

<style>
		.leaflet-container {
			height: 400px;
			width: 600px;
			max-width: 100%;
			max-height: 100%;
		}
</style>
<section class="font-open-sans leading-relaxed">
  <!-- breadcrumbs -->
  <div class="container mx-auto px-gutter pt-12">
    <div class="w-full font-sans font-semibold text-gray-ink py-3" aria-label="breadcrumb">
      <nav class="breadcrumb" aria-label="breadcrumb">
        <ol>
          <li class="breadcrumb_item hover:text-primary">
            <a href="/">{{__('Home')}}</a>
          </li>
          <li class="breadcrumb_item hover:text-primary">
            <a href="/collections">{{__('Collections')}}</a>
          </li>
          <li class="breadcrumb_item hover:text-primary">
            <a href="/collections/{{ dataset.groups[0].name}}">{{ dataset.groups[0].title }}</a>
          </li>
        </ol>
      </nav>
    </div>
  </div>
  <!-- end breadcrumbs -->

  <div class="container mx-auto md:flex px-gutter">
    <!-- page navigation nolumn -->
    <div class="hidden md:block md:w-1/4 md:mr-6 text-gray-900">
      <nav class="md:sticky md:top-0 py-gutter">
        <h3 class="text-2xl font-semibold pb-4">{{__('Get started')}}</h3>
        <ul class="text-gray-900 font-semibold text-base">
          <li class="py-3 hover:text-primary"><a href="#data">{{__('Data')}}</a></li>
          
          {% if dataset.methodologie  %}
          <li class="py-3 hover:text-primary"><a href="#methodology">{{__('Methodology')}}</a></li>
          {% endif %}
          
          {% if dataset.territoire  %}
          <li class="py-3 hover:text-primary"><a href="#territories">{{__('Territories')}}</a></li>
          {% endif %}
          
          {% if dataset.keywords %}
          <li class="py-3 hover:text-primary"><a href="#keywords">{{__('Keywords')}}</a></li>
          {% endif %}
          
          <li class="py-3 hover:text-primary"><a href="#additional-info">{{__('Additional Info')}}</a></li>
        </ul>
      </nav>
    </div>
    <!-- end page navigation column -->

    <!-- page content column -->
    <div class="md:w-2/3 pt-3 pb-5 text-gray-ink">
        <!-- info -->
        <div class="">
          <h1 class="py-2 text-4xl font-semibold text-gray-900">
            {{ dataset.title or dataset.name }} {{name}}
          </h1>
          <div class="text-sm-up py-1"> 
            <div class="flex flex-row">
              <p class="pr-2">{{__('Published by')}}</p>
              <a class="font-semibold text-sarcelle-dark hover:underline" href="/organization/{{ owner.name }}">{{ owner.title }}</a>
            {# <a class="py-2 text-primary" href="/collections/{{ dataset.groups[0].name}}">Where does this link go?</a> #}
          </div>

          <!-- readme -->
          <div class="container mt-12 mb-8 pt-16 border-t border-gray-400">
          {% if dataset.readmeSnippet or dataset.readmeHtml %}
            <div class="leading-relaxed text-lg">{{dataset.readmeHtml|safe}}</div>
          {% elif dataset.description %}
            <div class="markdown-content leading-relaxed">{{dataset.descriptionHtml|safe}}</div>
          {% endif %}
          </div>
        </div>
        <!-- end readme -->

        <h2 class="text-3xl font-semibold pt-gutter pb-4 text-gray-900">{{__('Data')}}</h2>

        <!-- resources table -->
        <table class="info block pb-12">
          <thead class="font-semibold text-left text-gray-900">
            <tr>
              <th class="px-4 py-3">{{__('Name')}}</th>
              <th class="px-4 py-3">{{__('Format')}}</th>
              <th class="px-4 py-3">{{__('Size')}}</th>
              <th class="px-4 py-3">{{__('Last Changed')}}</th>
              {# <th class="">{{__('Info & Preview')}}</th> #}
              <th class="px-4 py-3 overflow-hidden">{{__('Download')}}</th>
            </tr>
          </thead>
          <tbody>
          {% for item in dataset.displayResources %}
            <tr class="border-t border-gray-400">
              <td class="px-4 py-3">
                {# <a href="#{{ item.slug }}"> #}
                {{ item.resource.title or item.resource.name }}
                {# </a> #}
              </td>
              <td class="px-4 py-3 font-semibold text-base text-gray-900 uppercase"> {{ item.resource.format }}</td>
              <td class="px-4 py-3">{{ item.resource.sizeFormatted or '--' }}</td>
              <td class="px-4 py-3">
                <div class="has-tooltip">
                  <span class='local-date tooltip rounded shadow-md p-1 bg-gray-100 text-base ml-10 -mt-8'>
                    {{ (item.resource.last_modified or item.resource.created) }}</span>
                  <span class="border-dotted border-b border-gray-600">
                    {{ (item.resource.last_modified or item.resource.created) | formatDateFromNow }}
                  </span>
                </div>
              </td>
              {# <td class=""><a href="#{{item.slug}}"><i class="icon icon-preview text-base hover:text-primary"></i></a></td> #}
              <td class="px-4 py-3 text-base text-primary">
                <a href="{{ item.resource.path | replace(urls.ckanUrl, urls.proxyUrl) }}" onclick="sendGAEvent('{{ dataset.name }}', '{{ item.resource.name }}', '{{ item.resource.format }}')" download title="Download file" target="_blank">
                  {% include "./partials/symbol/svg/download.svg" %}
                </a>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
        <!-- end resources table -->
        
        <!-- data -->
        <div id="data" class="py-2">

          <!-- data views -->
      		{% include "./partials/resource-display.njk" %}
		      <!-- data views end -->
          
        </div>
        <!-- end data -->
      
        <!-- methodologie -->
        {% if dataset.methodologie  %}
        <div id="methodology" class="py-2">
          <h2 class="text-3xl font-semibold pt-gutter pb-4 text-gray-900">{{__('Methodology')}}</h2>
          <div class="markdown-content leading-relaxed">{{dataset.methodologie|processMarkdown|safe}}</div>
        </div>
        {% endif %}
        <!-- end methodologie -->

        <!-- territoire -->
        {% if dataset.territoire %}
        <h2 class="text-3xl font-semibold pt-gutter pb-4 text-gray-900">{{__('Territories')}}</h2>
          <div id="hidden-territories" class="hidden">
            {% for t in dataset.territoire %}
            <p id="hidden-p">{{territoires[t] | safe or ''}}</p>
            {% endfor %}

          </div>
        <div id="map" class="py-2">
                
        </div class="pb-4">
        {% endif %}
        <!-- end territories -->

        <!-- keywords -->
        {% if dataset.keywords %}
        <div id="keywords" class="py-2">
          <h2 class="text-3xl font-semibold pt-gutter pb-2 text-gray-900">{{__('Keywords')}}</h2>
          <div class="flex flex-wrap ">
          {% for t in dataset.keywords %} 
            <a href="/search?q=tags:{{t | safe}}" class="font-bold text-sm text-primary lowercase border-1 border-gray-400 rounded py-1 px-2 mr-3 my-2 hover:border-primary">{{t | safe}}</a>
          {% endfor %}
          </div class="pb-4">
        </div>
        {% endif %}
        <!-- end keywords -->

        <!-- additional info -->
        <div id="additional-info" class="py-2">
          <h2 class="text-3xl font-semibold pt-gutter pb-4 text-gray-900">{{__('Additional Information')}}</h2>
          <div class="py-2">
            <h3 class="font-semibold text-gray-900">{{__('Publisher')}}</h3>
            <p>{{ dataset.sources[0].name | dump | safe | replace('\"', '') or '--'}}</p>
          </div>
          <div class="py-2">
            <h3 class="font-semibold text-gray-900">{{__('Temporal coverage')}}</h3>
            <p>{{ dataset.temporal or '--'}}</p>
          </div>
          <div class="py-2">
            <h3 class="font-semibold text-gray-900">{{__('Source (URL)')}}</h3>
            {% if dataset.sources[0].web %}
            <a href="{{ dataset.sources[0].web }}" class="hover:text-sarcelle-dark underline">{{ dataset.sources[0].web or '--'}}</a>
            {% else %}
            <p> -- </p>
            {% endif %}
          </div>
          <div class="py-2">
            <h3 class="font-semibold text-gray-900">{{__('Update frequency')}}</h3>
            <p>{{ __(dataset.update_frequency) or '--'}}</p>
          </div>
          <div class="py-2">
            <h3 class="font-semibold text-gray-900">{{__('Descriptive Information Last Updated')}}</h3>
            <div class="has-tooltip">
                <span class='tooltip rounded shadow-md p-1 bg-gray-100 text-base ml-10 -mt-8'>{{ dataset.metadata_modified  | formatDate}}</span>
                <span class="border-dotted border-b border-gray-600">
                  {{ dataset.metadata_modified | formatDateFromNow }}
                </span>
            </div>
          </div>
          <div class="py-2">
            <h3 class="font-semibold text-gray-900">{{__('Date the dataset was first added')}}</h3>
            <p>{{ dataset.metadata_created | formatDate }}</p>
          </div>
          <!-- <p>{{ dataset.license_url }}</p> -->
          <!-- end Additional Info section -->

          <!-- Organization block -->
          <div class="container flex mt-12 mb-8 pt-4 items-center border-t border-gray-400">
            <div class="w-1/4 pr-4">
              <img class="inline-block w-full" src="{{ owner.avatar }}"/>
            </div>
            <div class="flex flex-col w-3/4">
              <h2 class="text-black text-xl font-semibold hover:underline">
                <a href="/organization/{{ owner.name }}">{{ owner.title }}</a>
              </h2>
              <p class="py-2 text-sm text-justify">
                {{ owner.description | safe }}
              </p>
            </div>
          </div>
          <!-- End of Organization block>

          <!-- data files (downloads) -->
          {# {% include "./partials/resource-display.njk" %} #}
          <!-- info end -->
        </div>
        <!-- end additional info -->

        <!-- disqus -->
        <div class="container mx-auto p-gutter">
          <div id="disqus_thread"></div>
        </div>
        <!-- end disqus -->
      </div>
    </div>
    <!-- end page content column -->

    <!-- <div class="w-full md:w-1/4 md:ml-12">
      <div data-title="activity-feed">
          <div class="border-solid border-2 border-black mt-4"></div>
        <h3 class="text-4xl font-semibold text-zambezi my-4">{{__('Activity Feed')}}</h3>
      </div>
      {{ activities.feed | safe }}
      {% if activities.limit < 31 %}
      <ul>
        <li><a href="?activity=31" class="text-primary">{{ __('See the whole list')}}</a></li>
      </ul>
      {% endif %}
    </div> -->
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
//show the date and time in the local time set by the user's browser
window.onload = function utcDatetoLocalDate(date) {
  var elements = document.getElementsByClassName('local-date tooltip rounded shadow-md p-1 bg-gray-100 text-base ml-10 -mt-8');
  for (let item of elements) {
    var date = (item.textContent.trim());

    date = convertUTCDateToLocalDate(new Date(date));
    date = formatDate(date)

    item.textContent = date;
  }
}

function convertUTCDateToLocalDate(date) {
  var newDate = new Date(date.getTime() + date.getTimezoneOffset() * 60 * 1000);

  var offset = date.getTimezoneOffset() / 60;
  var hours = date.getHours();

  newDate.setHours(hours - offset);

  return newDate;
}

function padTo2Digits(num) {
  return num.toString().padStart(2, '0');
}

function formatDate(date) {
  return (
    [
      date.getFullYear(),
      padTo2Digits(date.getMonth() + 1),
      padTo2Digits(date.getDate()),
    ].join('-') +
    ' ' +
    [
      padTo2Digits(date.getHours()),
      padTo2Digits(date.getMinutes())
    ].join(':')
  );
}
//end of show date and time in local time 
</script>
<script src="/static/js/geojson.js"></script>
<!-- <script src="/static/js/leafletMap.js"></script> -->
<script>
  
  const teritoriesList = [...document.querySelectorAll("#hidden-territories > p")].map(e => e.innerHTML);
  let updatedGeoJson
  if (teritoriesList.includes("Agglomération")) {
    updatedGeoJson = teritories.features
  } else if (teritoriesList.includes("Montréal")) {
    updatedGeoJson = teritories.features.filter((el) => el.properties.TYPE === "Arrondissement")
  } else {
    updatedGeoJson = teritories.features.filter((el) => teritoriesList.includes(el.properties.NOM))
  }
  
  // Leaflet Map

  var map = L.map('map').setView([45.55, -73.7], 10);

var tiles = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
  maxZoom: 18,
  attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
    'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
  id: 'mapbox/light-v9',
  tileSize: 512,
  zoomOffset: -1
}).addTo(map);


// control that shows state info on hover
var info = L.control();

info.onAdd = function (map) {
  this._div = L.DomUtil.create('div', 'info');
  this.update();
  return this._div;
};

info.update = function (props) {
  this._div.innerHTML = props ?
    '<b>' + props.NOM : ""
};
info.addTo(map);

function getColor(d) {
  return d > 1000 ? '#800026' :
    d > 500  ? '#BD0026' :
    d > 200  ? '#E31A1C' :
    d > 100  ? '#FC4E2A' :
    d > 50   ? '#FD8D3C' :
    d > 20   ? '#FEB24C' :
    d > 10   ? '#FED976' : '#097d6c';
}

function style(feature) {
  return {
    weight: 2,
    opacity: 1,
    color: 'white',
    dashArray: '3',
    fillOpacity: 0.7,
    fillColor: getColor(feature.properties.density)
  };
}

function highlightFeature(e) {
  var layer = e.target;
  layer.setStyle({
    weight: 2,
    color: '#666',
    dashArray: '',
    fillOpacity: 0.5
  });
  if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
    layer.bringToFront();
  }
  info.update(layer.feature.properties);
}

var geojson;

function resetHighlight(e) {
  geojson.resetStyle(e.target);
  info.update();
}

function zoomToFeature(e) {
  map.fitBounds(e.target.getBounds());
}

function onEachFeature(feature, layer) {
  layer.on({
    mouseover: highlightFeature,
    mouseout: resetHighlight,
    click: zoomToFeature
  });
}
geojson = L.geoJson(updatedGeoJson, {
  style: style,
  onEachFeature: onEachFeature
}).addTo(map);

// Leaflet Map

  function toggleApi(i) {
    const el = document.getElementById(`data-api-info-${i}`)
    const body = document.body
    if (el.style.display === "none") {
      el.style.display = "block"
      body.classList.add("overflow-y-hidden")
    } else {
      el.style.display = "none"
      body.classList.remove("overflow-y-hidden")
    }
  } 

  function copyFromEl(i, el)  {
    const val = document.getElementById(`${el}-${i}`)
    val.select()
    val.setSelectionRange(0, 99999)
    document.execCommand("copy")
  }

  function sendGAEvent(datasetName, resourceName, resourceFormat) {
    gtag('event', "download", {
      'event_category': datasetName,
      'event_label': resourceName,
      'value':resourceFormat,
      'non_interaction': true
    });
  }
</script>
<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://donnees-montreal.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            
<script type="text/javascript" src="/static/js/dataexplorer/runtime~main.a8a9905a.js"></script>
<script type="text/javascript" src="/static/js/dataexplorer/2.30cee88f.chunk.js"></script>
<script type="text/javascript" src="/static/js/dataexplorer/main.1157632d.chunk.js"></script>

{% endblock %}
